# 28. EFI\_SHELL\_PROTOCOL을 통하여 ACPI 테이블을 파일에 저장하기

최신 ACPI 사양은 UEFI 사양 페이지([https://uefi.org/specifications](https://uefi.org/specifications))에서 찾을 수 있다.\
현재 최신 사양은 "ACPI Specification Version 6.4 (released January 2021"([https://uefi.org/sites/default/files/resources/ACPI\_Spec\_6\_4\_Jan22.pdf](https://uefi.org/sites/default/files/resources/ACPI\_Spec\_6\_4\_Jan22.pdf))이다.

SMBIOS 테이블에 사용한 것과 동일한 방법을 사용하여 ACPI 진입점 테이블 주소를 출력하겠다.

```
#include <Library/UefiBootServicesTableLib.h>
#include <Library/UefiLib.h>

#include <Library/BaseMemoryLib.h>

EFI_STATUS
EFIAPI
UefiMain (
  IN EFI_HANDLE        ImageHandle,
  IN EFI_SYSTEM_TABLE  *SystemTable
  )
{
  for (UINTN i=0; i<SystemTable->NumberOfTableEntries; i++) {
    if (CompareGuid(&(SystemTable->ConfigurationTable[i].VendorGuid), &gEfiAcpi20TableGuid)) {
      Print(L"ACPI table is placed at %p\n\n", SystemTable->ConfigurationTable[i].VendorTable);
    }
  }
  return EFI_SUCCESS;
}
```

출력된 ACPI 테이블 주소를 바탕으로 `dmem`을 사용하여 메모리 내부 값을 확인하겠다.

```
FS0:\> AcpiInfo.efi
ACPI table is placed at 7B7E014

FS0:\> dmem 7B7E014 30
Memory Address 0000000007B7E014 30 Bytes
  07B7E014: 52 53 44 20 50 54 52 20-4E 42 4F 43 48 53 20 02  *RSD PTR NBOCHS .*
  07B7E024: 74 D0 B7 07 24 00 00 00-E8 D0 B7 07 00 00 00 00  *t...$...........*
  07B7E034: 66 00 00 00 AF AF AF AF-AF AF AF AF AF AF AF AF  *f...............*
FS0:\>
```

시그니처 값인 `RSP PTR`은 `RSDP(Root System Description Pointer (RSDP) Structure)`를 나타낸다.\
[https://uefi.org/specs/ACPI/6.4/05\_ACPI\_Software\_Programming\_Model/ACPI\_Software\_Programming\_Model.html#root-system-description-pointer-rsdp-structure](https://uefi.org/specs/ACPI/6.4/05\_ACPI\_Software\_Programming\_Model/ACPI\_Software\_Programming\_Model.html#root-system-description-pointer-rsdp-structure)

여기에는 `RSDT` 및 `XSDT` 테이블에 대한 주소가 포함되며 오프셋을 계산시 메모리 덤프에서 다음과 같은 주소를 얻을 수 있다.

```
XSDT=0x07B7D0E8
RSDT=0x07B7D074
```

이러한 테이블은 실제로 OS에 유용한 데이터를 포함하는 다른 ACPI 테이블에 대한 포인터를 포함한다.

규격에 따르면 "플랫폼은  ACPI 1.0 운영체제와 호환성을 가능하게 하는 RSDT를 제공합니다. XSDT는 RSDT 기능을 대체합니다." 따라서 `dmem`을 사용하여 이러한 주소를 출력하면 테이블 내용은 테이블 서명을 제외하고는 거의 동일하다. 따라서 XSDT 테이블 데이터를 parse하겠다.

이제 코드를 작성해보겠다. ACPI 구조에 대한 정의는 아래의 헤더 파일들에 존재하니 확인하는 것도 좋다.\


```
$ ls -1 MdePkg/Include/IndustryStandard/Acpi*
MdePkg/Include/IndustryStandard/Acpi.h
MdePkg/Include/IndustryStandard/Acpi10.h
MdePkg/Include/IndustryStandard/Acpi20.h
MdePkg/Include/IndustryStandard/Acpi30.h
MdePkg/Include/IndustryStandard/Acpi40.h
MdePkg/Include/IndustryStandard/Acpi50.h
MdePkg/Include/IndustryStandard/Acpi51.h
MdePkg/Include/IndustryStandard/Acpi60.h
MdePkg/Include/IndustryStandard/Acpi61.h
MdePkg/Include/IndustryStandard/Acpi62.h
MdePkg/Include/IndustryStandard/Acpi63.h
MdePkg/Include/IndustryStandard/AcpiAml.h
```

최신 헤더에는 이전 헤더들이 포함되어 있음을 명심하자.

```
Acpi.h > Acpi63.h > Acpi62.h > ... > Acpi10.h > AcpiAml.h
```

최신 ACPI 표준 헤더 파일에서 RSDP 구조에 대한 정의를 살펴보겠다.\
[https://github.com/tianocore/edk2/blob/master/MdePkg/Include/IndustryStandard/Acpi63.h](https://github.com/tianocore/edk2/blob/master/MdePkg/Include/IndustryStandard/Acpi63.h)

```
///
/// Root System Description Pointer Structure
///
typedef struct {
  UINT64  Signature;
  UINT8   Checksum;
  UINT8   OemId[6];
  UINT8   Revision;
  UINT32  RsdtAddress;
  UINT32  Length;
  UINT64  XsdtAddress;
  UINT8   ExtendedChecksum;
  UINT8   Reserved[3];
} EFI_ACPI_6_3_ROOT_SYSTEM_DESCRIPTION_POINTER;
```











