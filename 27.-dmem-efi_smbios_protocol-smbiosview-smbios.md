# 27. dmem/EFI\_SMBIOS\_PROTOCOL/smbiosview를 통해서 SMBIOS 정보 가져오기

이전 챕터에서 확인한 시스템 테이블 중 SMBIOS에 대해서 알아보도록 하겠다.\


"System Management BIOS(SMBIOS) 참조  규격"의 최신 버전은 아래의 사이트에서 확인할 수 있으며\
현재는 3.6.0이 최신 버전인 것을 알 수 있다.\
[https://www.dmtf.org/dsp/DSP0134](https://www.dmtf.org/dsp/DSP0134)

이전 시간에 우리는 SMBIOS  테이블이 `gEfiSmbiosTableGuid` 에 선언된 것을 확인했다.

해당 테이블의 주소를 인쇄하는 간단한 앱을 만들어 보겠다.

```
#include <Library/UefiBootServicesTableLib.h>
#include <Library/UefiLib.h>

#include <Library/BaseMemoryLib.h>

EFI_STATUS
EFIAPI
UefiMain (
  IN EFI_HANDLE        ImageHandle,
  IN EFI_SYSTEM_TABLE  *SystemTable
  )
{
  for (UINTN i=0; i<SystemTable->NumberOfTableEntries; i++) {
    if (CompareGuid(&(SystemTable->ConfigurationTable[i].VendorGuid), &gEfiSmbiosTableGuid)) {
      Print(L"SMBIOS table is placed at %p\n", SystemTable->ConfigurationTable[i].VendorTable);
    }
  }
  return EFI_SUCCESS;
}
```

해당 코드에서 사용된 CompareGuid 함수는 아래의 코드에서 정의가 되어있다.\
[https://github.com/tianocore/edk2/blob/master/MdePkg/Include/Library/BaseMemoryLib.h](https://github.com/tianocore/edk2/blob/master/MdePkg/Include/Library/BaseMemoryLib.h)

```
/**
  Compares two GUIDs.
  This function compares Guid1 to Guid2.  If the GUIDs are identical then TRUE is returned.
  If there are any bit differences in the two GUIDs, then FALSE is returned.
  If Guid1 is NULL, then ASSERT().
  If Guid2 is NULL, then ASSERT().
  @param  Guid1       A pointer to a 128 bit GUID.
  @param  Guid2       A pointer to a 128 bit GUID.
  @retval TRUE        Guid1 and Guid2 are identical.
  @retval FALSE       Guid1 and Guid2 are not identical.
**/
BOOLEAN
EFIAPI
CompareGuid (
  IN CONST GUID  *Guid1,
  IN CONST GUID  *Guid2
  );
```

잊지 말고 inf파일에GUID에 값을 추가 해주자.

```
[Guids]
  gEfiSmbiosTableGuid
```

빌드 후 실행하면 아래와 같이 주소가 나오는 것을 볼 수 있다.

```
FS0:\> SmbiosInfo.efi
SMBIOS table is placed at BF53F000
```



## `dmem`을 통한 SMBIOS 테이블 가져오기

UEFI shell에는 memory를 dump하는 `dmem`이라는 명령어가 존재한다.

```
FS0:\> dmem -? -b
Displays the contents of system or device memory.

DMEM [-b] [address] [size] [-MMIO]

  -b      - Displays one screen at a time.
  -MMIO   - Forces address cycles to the PCI bus.
  address - Specifies a starting address in hexadecimal format.
  size    - Specifies the number of bytes to display in hexadecimal format.

NOTES:
  1. This command displays the contents of system memory or device memory.
  2. Enter address and size in hexadecimal format.
  3. If address is not specified, the contents of the UEFI System Table
     are displayed. Otherwise, memory starting at the specified address is displayed.
  4. Size specifies the number of bytes to display. If size is not specified,
     512 bytes are displayed.
  5. If MMIO is not specified, main system memory is displayed. Otherwise,
     device memory is displayed through the use of the
     EFI_PCI_ROOT_BRIDGE_IO_PROTOCOL.

EXAMPLES:
  * To display the UEFI system table pointer entries:
    fs0:\> dmem

  * To display memory contents from 1af3088 with size of 16 bytes:
    Shell> dmem 1af3088 16

  * To display memory mapped IO contents from 1af3088 with a size of 16 bytes:
    Shell> dmem 1af3088 16 -MMIO
```

SMBIOS 테이블 포인터로 출력된 0x793F000주소에서 0x30 바이트를 출력해보겠다.

```
FS0:\> dmem BF53F000 30
Memory Address 00000000BF53F000 30 Bytes
  BF53F000: 5F 53 4D 5F 26 1F 02 08-53 00 00 00 00 00 00 00  *_SM_&...S.......*
  BF53F010: 5F 44 4D 49 5F 2B 91 01-00 E0 93 07 09 00 28 AF  *_DMI_+........(.*
  BF53F020: AF AF AF AF AF AF AF AF-AF AF AF AF AF AF AF AF  *................*
```

SMBIOS 규격에 나와있는 SMBIOS Entry Point 구조에 따르면 `_SM_` 및 `_DMI_`가 해당 구조에서 미리 정의된 값임을 알 수 있다.

<figure><img src=".gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

SMBIOS에 대한 구조는 edk2에서 또한찾을 수 있다.\
[https://github.com/tianocore/edk2/blob/master/MdePkg/Include/IndustryStandard/SmBios.h](https://github.com/tianocore/edk2/blob/master/MdePkg/Include/IndustryStandard/SmBios.h)

```
typedef struct {
  UINT8   AnchorString[4];
  UINT8   EntryPointStructureChecksum;
  UINT8   EntryPointLength;
  UINT8   MajorVersion;
  UINT8   MinorVersion;
  UINT16  MaxStructureSize;
  UINT8   EntryPointRevision;
  UINT8   FormattedArea[5];
  UINT8   IntermediateAnchorString[5];
  UINT8   IntermediateChecksum;
  UINT16  TableLength;
  UINT32  TableAddress;
  UINT16  NumberOfSmbiosStructures;
  UINT8   SmbiosBcdRevision;
} SMBIOS_TABLE_ENTRY_POINT;
```

해당 구조를 따라서 dump된 메모리를 계산하면 아래와 같이 볼 수 있다.\
시스템에는 0xBF53E000에서 (0xBF53E000+0x1B2)까지 배치된 0xA개의 SMBIOS 구조가 존재한다.\
(환경별로 상이할 가능성 존재)

<figure><img src=".gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

SMBIOS구조의 주소를 ㅎ







