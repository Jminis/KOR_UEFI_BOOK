# 31. ShellLib/PrintLib 함수를 사용해 pci.ids DB에서 PCI Vendor/Device 정보 가져오기

이번 장에서는 ListPCI 유틸리티를 수정하여 PCI Vendor와 Device에 대한 정보를 확인한다. 여기서 출력할 정보는 UEFI Shell에서 `pci` 명령을 통해서 확인할 수 없는 정보이다. `pci` 명령은 PCI 클래스와 서브 클래스 코드에 대한 정보만 표시하기 때문에 여기서 하는 작업은 유용하게 사용할 수 있다.

`pci` 명령 소스코드 확인 링크

* [https://github.com/tianocore/edk2/blob/master/ShellPkg/Library/UefiShellDebug1CommandsLib/Pci.c](https://github.com/tianocore/edk2/blob/master/ShellPkg/Library/UefiShellDebug1CommandsLib/Pci.c)
* [https://github.com/tianocore/edk2/blob/master/ShellPkg/Library/UefiShellDebug1CommandsLib/Pci.h](https://github.com/tianocore/edk2/blob/master/ShellPkg/Library/UefiShellDebug1CommandsLib/Pci.h)

이번 장은 fpmurphy의 `ShowPCIx(`[`https://github.com/fpmurphy/UEFI-Utilities-2019/tree/master/MyApps/ShowPCIx`](https://github.com/fpmurphy/UEFI-Utilities-2019/tree/master/MyApps/ShowPCIx)`)`앱을 참고하여 작성하였다.

먼저, 이전에 만들었던 `ListPCI.c`에 코드를 기반으로 Vendor와 Device 설명을 채울 수 있는 `FindPCIDevDescription` 함수를 생성한다.

```c
EFI_STATUS FindPCIDevDescription(IN UINT16 VendorId,
                                 IN UINT16 DeviceId,
                                 OUT CHAR16* VendorDesc,
                                 OUT CHAR16* DeviceDesc,
                                 IN UINTN DescBufferSize)
```

아래 코드는&#x20;

```
if (PCIConfHdr.VendorId != 0xffff) {
  Print(L"  %02x:%02x.%02x - Vendor:%04x, Device:%04x",
                                                          Bus,
                                                          Device,
                                                          Func,
                                                          PCIConfHdr.VendorId,
                                                          PCIConfHdr.DeviceId);

  CHAR16 VendorDesc[DESCRIPTOR_STR_MAX_SIZE];
  CHAR16 DeviceDesc[DESCRIPTOR_STR_MAX_SIZE];
  Status = FindPCIDevDescription(PCIConfHdr.VendorId,
                                 PCIConfHdr.DeviceId,
                                 VendorDesc,
                                 DeviceDesc,
                                 DESCRIPTOR_STR_MAX_SIZE);
  if (!EFI_ERROR(Status)) {
    Print(L":    %s, %s\n", VendorDesc, DeviceDesc);
  } else {
    Print(L"\n");
  }
}
```

이 코드에서 `DESCRIPTOR_STR_MAX_SIZE`는 Vendor와 Device 설명의 최대 크기이다. `VendorDesc`와 `DeviceDesc`를 단순화하기 위해 정적 배열을 선언하고 모든 설명을 포함할 수 있을 만큼 충분한 크기의 배열 크기를 선택해야 한다.

```
#define DESCRIPTOR_STR_MAX_SIZE 200
```

이제 `FindPCIDevDescription`을 사용해본다.

Public PCI ID Repository([https://pci-ids.ucw.cz/](https://pci-ids.ucw.cz/))에서 PCI Vendor와 Device 정보를 얻을 수 있다. 이 사이트에서는 공개된 PCI Vendor와 Devcie 조합이 포함된 pci.ids([https://pci-ids.ucw.cz/v2.2/pci.ids](https://pci-ids.ucw.cz/v2.2/pci.ids)) 파일이 배포된다.

파일의 시작에는 정보가 표시되는 방법에 대한 설명이 있다.

```
# Syntax:
# vendor  vendor_name
#	device  device_name				<-- single tab
#		subvendor subdevice  subsystem_name	<-- two tabs
```

필요한 `pci.ids` 파일을 QEMU 공유 폴더에 다운로드 받는다.

```
$ cd ~/UEFI_disk
$ wget https://pci-ids.ucw.cz/v2.2/pci.ids
```

이제 함수를 작성한다.

먼저 PCI 데이터베이스 파일이 실제로 존재하는지 확인해야 한다.

해당 작업은 ShellLib의 함수를 활용할 수 있다.\
[https://github.com/tianocore/edk2/blob/master/ShellPkg/Include/Library/ShellLib.h](https://github.com/tianocore/edk2/blob/master/ShellPkg/Include/Library/ShellLib.h)

```
/**
  Function to determine if a given filename exists.
  @param[in] Name         Path to test.
  @retval EFI_SUCCESS     The Path represents a file.
  @retval EFI_NOT_FOUND   The Path does not represent a file.
  @retval other           The path failed to open.
**/
EFI_STATUS
EFIAPI
ShellFileExists(
  IN CONST CHAR16 *Name
  );
```



