# 16. OVMF 이미지 내에 부팅 옵션 만들기

이전 과정에서는 현재 부팅 옵션을 보여주는 앱을 개발했다.

```
FS0:\> ShowBootVariables.efi
Boot0000
UiApp
Fv(7CB8BDC9-F8EB-4F34-AAEA-3EE4AF6516A1)/FvFile(462CAA21-7614-4503-836E-8AB6F4662331)

Boot0001
UEFI QEMU DVD-ROM QM00003
PciRoot(0x0)/Pci(0x1,0x1)/Ata(0x0)

Boot0002
UEFI QEMU HARDDISK QM00001
PciRoot(0x0)/Pci(0x1,0x1)/Ata(0x0)

Boot0003*
EFI Internal Shell
Fv(7CB8BDC9-F8EB-4F34-AAEA-3EE4AF6516A1)/FvFile(7C04A583-9E3E-4F1C-AD65-E05268D0B4D1)
```

출력된 GUID에 대한 정보를 확인하려면 아래의 링크를 통해 확인할 수 있다.

* `FILE_GUID = 7C04A583-9E3E-4f1c-AD65-E05268D0B4D1 # gUefiShellFileGuid`\
  [https://github.com/tianocore/edk2/blob/master/ShellPkg/Application/Shell/Shell.inf](https://github.com/tianocore/edk2/blob/master/ShellPkg/Application/Shell/Shell.inf)
* `FILE_GUID = 462CAA21-7614-4503-836E-8AB6F4662331` - UiApp module is driver for BDS phase\
  [https://github.com/tianocore/edk2/blob/master/MdeModulePkg/Application/UiApp/UiApp.inf](https://github.com/tianocore/edk2/blob/master/MdeModulePkg/Application/UiApp/UiApp.inf)

`7CB8BDC9-F8EB-4F34-AAEA-3EE4AF6516A1`는 OVMF 이미지의 펌웨어 볼륨에 대한  GUID이다.\
[https://github.com/tianocore/edk2/blob/master/OvmfPkg/OvmfPkgX64.fdf](https://github.com/tianocore/edk2/blob/master/OvmfPkg/OvmfPkgX64.fdf)

\*.fdf 파일에는 SEC, PEI 또는 DXE 단계의 볼륨을 포함하여 모든 볼륨에 배치되는 드라이버와 앱의 리스트를 가지고 있다.

```
...

[FV.SECFV]
FvNameGuid         = 763BED0D-DE9F-48F5-81F1-3E90E1B1A015
BlockSize          = 0x1000
FvAlignment        = 16
...
INF <...>
...

[FV.PEIFV]
FvNameGuid         = 6938079B-B503-4E3D-9D24-B28337A25806
BlockSize          = 0x10000
FvAlignment        = 16
...
INF <...>
...

[FV.DXEFV]
FvForceRebase      = FALSE
FvNameGuid         = 7CB8BDC9-F8EB-4F34-AAEA-3EE4AF6516A1        ### <---- this is a GUID from our output
BlockSize          = 0x10000
FvAlignment        = 16
...
INF  ShellPkg/Application/Shell/Shell.inf          <--- this apps are placed in the FV.DXEFV firmware volume
...
INF  MdeModulePkg/Application/UiApp/UiApp.inf
```

전체 edk2 FDF 파일 사양 확인\
[https://edk2-docs.gitbook.io/edk-ii-fdf-specification/](https://edk2-docs.gitbook.io/edk-ii-fdf-specification/)



[https://github.com/tianocore/edk2/blob/master/ShellPkg/Application/Shell/Shell.inf](https://github.com/tianocore/edk2/blob/master/ShellPkg/Application/Shell/Shell.inf)\
위 링크를 통해 EFI Shell은 간단한 UEFI\_APPLICATION인 것을 알 수 있다. 지금까지 여러 앱을 만들어봤으니 이번에는 부팅 옵션에 앱을 추가한다.

부팅 옵션에 HelloWorld 앱을 부팅 옵션에 추가해볼 것이다. 따라서 EFI Shell 앱이 어떻게 OVMF에 추가되어 있는지 살펴본다.

먼저 OVMF 이미지에 앱을 추가해야 한다. UefiLessonsPkg/HelloWorld/HelloWorld.inf 경로를 OvmfPkg/OvmfPkgX64.fdf 파일에 있는 \[FV.DXEFV]의 ShellPkg/Application/Shell/Shell.inf 아래에 추가한다.

```
[FV.DXEFV]
FvForceRebase      = FALSE
FvNameGuid         = 7CB8BDC9-F8EB-4F34-AAEA-3EE4AF6516A1
BlockSize          = 0x10000
FvAlignment        = 16
...

  INF  ShellPkg/Application/Shell/Shell.inf
+ INF  UefiLessonsPkg/HelloWorld/HelloWorld.inf
...
```

추가한 후 새로 OVMF를 빌드하려고 하면 아래와 같은 에러가 발생한다. 해당 오류는 OvmfPkg/OvmfPkgX64.dsc에 HelloWorld 앱에 대한 정보가 추가되지 않아 발생하는 오류이다.

```
$ build --platform=OvmfPkg/OvmfPkgX64.dsc --arch=X64 --buildtarget=RELEASE --tagname=GCC5
...
build.py...
 : error F001: Module /home/kostr/tiano/edk2/UefiLessonsPkg/HelloWorld/HelloWorld.inf NOT found in DSC file; Is it really a binary module?
...
```

OvmfPkgX64.dsc에 HelloWorld 앱에 대한 정보를 추가하기 위해 아래와 같이 \[Components]에 있는 ShellPkg 아래에 추가한다.

```
[Components]
  ...
  ShellPkg/Application/Shell/Shell.inf {
   ...
  }
+ UefiLessonsPkg/HelloWorld/HelloWorld.inf
  ...
```
